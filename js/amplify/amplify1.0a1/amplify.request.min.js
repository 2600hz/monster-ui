/*!
 * Amplify Request 1.0a1
 * 
 * Copyright 2011 appendTo LLC. (http://appendto.com/team)
 * Dual licensed under the MIT or GPL licenses.
 * http://appendto.com/open-source-licenses
 * 
 * http://amplifyjs.com
 */
(function(d,k,o){d.request=function(a,c,f){var b=a||{};if(typeof b==="string"){if(k.isFunction(c)){f=c;c={}}b={resourceId:a,data:c||{},success:f}}a=d.request.resources[b.resourceId];var e=b.success||k.noop,g=b.error||k.noop;b.success=function(h,i){d.publish("request.success",b,h,i);d.publish("request.complete",b,h,i);e.apply(this,arguments)};b.error=function(h,i){d.publish("request.error",b,h,i);d.publish("request.complete",b,h,i);g.apply(this,arguments)};if(!a){if(!b.resourceId)throw"amplify.request: no resourceId provided";
throw"amplify.request: unknown resourceId: "+b.resourceId;}d.publish("request.before",b)&&d.request.resources[b.resourceId](b)};k.extend(d.request,{types:{},resources:{},define:function(a,c,f){if(typeof c==="string"){if(!(c in d.request.types))throw"amplify.request.define: unknown type: "+c;f.resourceId=a;d.request.resources[a]=d.request.types[c](f)}else d.request.resources[a]=c}});d.request.types.ajax=function(a){a=k.extend({type:"GET"},a);return function(c){var f=a.url,b=c.data,e;if(typeof b!==
"string"){b=k.extend(true,{},a.data,b);k.each(b,function(g,h){e=RegExp("{"+g+"}","g");if(e.test(f)){f=f.replace(e,h);delete b[g]}})}k.ajax(k.extend({},a,{url:f,type:a.type,data:b,dataType:a.dataType,success:function(g,h,i){c.success(g,i)},error:function(g,h,i,j){if(j===o)j=null;c.error(j,g)},beforeSend:function(g,h){return(a.beforeSend?a.beforeSend.apply(this,arguments):true)&&d.publish("request.before.ajax",a,c,h,g)}}))}};var l=d.request.cache={_key:function(a,c){function f(){return c.charCodeAt(e++)<<
24|c.charCodeAt(e++)<<16|c.charCodeAt(e++)<<8|c.charCodeAt(e++)<<0}for(var b=c.length,e=0,g=f();e<b;)g^=f();return"request-"+a+"-"+g},_default:function(){var a={};return function(c,f,b){var e=l._key(c.resourceId,b.data),g=c.cache;if(e in a){b.success(a[e]);return false}var h=b.success;b.success=function(i){a[e]=i;typeof g==="number"&&setTimeout(function(){delete a[e]},g);h.apply(this,arguments)}}}()};if(d.store){k.each(d.store.types,function(a){l[a]=function(c,f,b){var e=l._key(c.resourceId,b.data);
if(c=d.store[a](e)){b.success(c);return false}var g=b.success;b.success=function(h){d.store[a](e,h);g.apply(this,arguments)}}});l.persist=l[d.store.type]}d.subscribe("request.before.ajax",function(a){var c=a.cache;if(c)return l[c in l?c:"_default"].apply(this,arguments)});d.request.decoders={jsend:function(a,c,f,b,e){if(a.status==="success")b(a.data);else if(a.status==="fail")e(a.data,"fail");else if(a.status==="error"){delete a.status;e(a)}}};d.subscribe("request.before.ajax",function(a,c,f){function b(j){return function(m){g(m,
"success",j)}}function e(j){return function(m){h(j,"error",null,m)}}var g=f.success,h=f.error,i=k.isFunction(a.decoder)?a.decoder:a.decoder in d.request.decoders?d.request.decoders[a.decoder]:d.request.decoders._default;if(i){f.success=function(j,m,n){i(j,m,n,b(n),e(n))};f.error=function(j,m){i(null,m,j,b(j),e(j))}}})})(amplify,jQuery);
